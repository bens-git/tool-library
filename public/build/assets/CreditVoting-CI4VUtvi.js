import{o as Z,y as ee,r as n,b as y,w as a,d as o,u as te,h as oe,f as r,j as u,m as k,F as ae,z as le,t as v,p as T,e as c,a as N,i as d,x as ne}from"./app-Cl7cSYny.js";import{P as se}from"./PageLayout-D-q0Jw-F.js";import"./loading-B-pAuaq2.js";import"./response-BrJijees.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";const re={class:"mb-2"},ue={class:"text-primary"},de={class:"mb-2"},ie={class:"mb-2"},ve={key:0,class:"mb-2"},ce={key:1,class:"text-grey"},_e={key:2,class:"text-grey"},me={key:0,class:"text-center pa-8"},pe={class:"text-h6 text-center my-4"},fe=20,ke={__name:"CreditVoting",setup(ye){const i=d([]),B=d(""),g=d("name"),O=[{title:"Name",value:"name"},{title:"Current Rate",value:"current_daily_rate"}],S=d(1),_=d(!1),V=d(!0),U=d(null);let m=null;const b=d(!1),x=d(null),p=d(1),I=d(""),A=ne(()=>{let l=[...i.value];return l.sort((e,f)=>g.value==="name"?e.name.localeCompare(f.name):f[g.value]-e[g.value]),l}),L=()=>{i.value=[],S.value=1,V.value=!0,h()},h=async()=>{if(!(_.value||!V.value)){_.value=!0;try{const l=await N.get(route("archetypes.index"),{params:{page:S.value,itemsPerPage:fe,search:B.value||void 0}}),e=l.data.data||[],f=l.data.total||0,z=await Promise.all(e.map(async s=>{var R;try{const[C,w]=await Promise.all([N.get(route("votes.user",{archetypeId:s.id})),N.get(route("votes.can-vote",{archetypeId:s.id})).catch(()=>({data:{can_vote:!0}}))]);return{id:s.id,name:s.name,resource:s.resource,current_daily_rate:s.current_daily_rate||1,base_credit_value:s.base_credit_value||1,vote_count:s.vote_count||0,user_vote:C.data.has_vote?(R=C.data.vote)==null?void 0:R.vote_value:null,can_vote:w.data.can_vote,cooldown_days:w.data.cooldown_days||0}}catch{return{id:s.id,name:s.name,resource:s.resource,current_daily_rate:1,base_credit_value:1,vote_count:0,user_vote:null,can_vote:!0,cooldown_days:0}}}));i.value=[...i.value,...z],V.value=i.value.length<f,S.value++}catch(l){console.error("Failed to load archetypes:",l)}finally{_.value=!1}}},M=()=>{m&&m.disconnect(),m=new IntersectionObserver(l=>{l[0].isIntersecting&&!_.value&&V.value&&h()},{threshold:.1}),U.value&&m.observe(U.value)},Y=l=>{x.value=l,p.value=l.user_vote||l.current_daily_rate||1,I.value="",b.value=!0},$=async()=>{if(x.value)try{await N.post(route("votes.store"),{archetype_id:x.value.id,vote_value:p.value,reason:I.value}),b.value=!1;const l=i.value.findIndex(e=>e.id===x.value.id);l!==-1&&(i.value[l].user_vote=p.value,i.value[l].can_vote=!1,i.value[l].cooldown_days=7)}catch(l){console.error("Failed to submit vote:",l)}};return Z(()=>{h(),M()}),ee(()=>{m&&m.disconnect()}),(l,e)=>{const f=n("v-alert"),z=n("v-text-field"),s=n("v-col"),R=n("v-select"),C=n("v-row"),w=n("v-card-title"),j=n("v-card-subtitle"),E=n("v-chip"),P=n("v-btn"),F=n("v-card-text"),D=n("v-card"),W=n("v-progress-circular"),q=n("v-icon"),G=n("v-slider"),H=n("v-textarea"),J=n("v-spacer"),K=n("v-card-actions"),Q=n("v-dialog"),X=n("v-container");return u(),y(se,{title:"Vote on Credit Rates"},{default:a(()=>[o(te(oe),{title:"Vote on Credit Rates"}),o(X,null,{default:a(()=>[o(f,{type:"info",class:"mb-4"},{default:a(()=>[...e[6]||(e[6]=[r(" Participate in community voting to set credit rates for tool types (archetypes). You earn bonus credits for voting! Vote on how many credits it should cost to borrow each type of tool. ",-1)])]),_:1}),o(C,{class:"mb-4"},{default:a(()=>[o(s,{cols:"12",md:"6"},{default:a(()=>[o(z,{modelValue:B.value,"onUpdate:modelValue":[e[0]||(e[0]=t=>B.value=t),L],label:"Search archetypes...","prepend-inner-icon":"mdi-magnify",variant:"outlined","hide-details":""},null,8,["modelValue"])]),_:1}),o(s,{cols:"12",md:"6"},{default:a(()=>[o(R,{modelValue:g.value,"onUpdate:modelValue":e[1]||(e[1]=t=>g.value=t),items:O,label:"Sort by",variant:"outlined","hide-details":""},null,8,["modelValue"])]),_:1})]),_:1}),o(C,null,{default:a(()=>[(u(!0),k(ae,null,le(A.value,t=>(u(),y(s,{key:t.id,cols:"12",md:"6",lg:"4"},{default:a(()=>[o(D,null,{default:a(()=>[o(w,null,{default:a(()=>[r(v(t.name),1)]),_:2},1024),t.resource?(u(),y(j,{key:0},{default:a(()=>[r(" Type: "+v(t.resource),1)]),_:2},1024)):T("",!0),o(F,null,{default:a(()=>[c("div",re,[e[7]||(e[7]=c("strong",null,"Current Rate:",-1)),c("span",ue,v(t.current_daily_rate)+" ITC/day",1)]),c("div",de,[e[8]||(e[8]=c("strong",null,"Base Rate:",-1)),r(" "+v(t.base_credit_value||1)+" ITC/day ",1)]),c("div",ie,[e[9]||(e[9]=c("strong",null,"Votes:",-1)),r(" "+v(t.vote_count||0),1)]),t.user_vote?(u(),k("div",ve,[o(E,{color:"success",size:"small"},{default:a(()=>[r(" Your vote: "+v(t.user_vote)+" ITC/day ",1)]),_:2},1024)])):T("",!0),t.can_vote?(u(),y(P,{key:2,color:"primary",size:"small",onClick:ge=>Y(t)},{default:a(()=>[r(v(t.user_vote?"Change Vote":"Vote"),1)]),_:2},1032,["onClick"])):(u(),y(P,{key:1,color:"grey",size:"small",disabled:""},{default:a(()=>[r(" Cooldown: "+v(t.cooldown_days)+" days ",1)]),_:2},1024))]),_:2},1024)]),_:2},1024)]),_:2},1024))),128))]),_:1}),c("div",{ref_key:"loadTrigger",ref:U,class:"text-center pa-4"},[_.value?(u(),y(W,{key:0,indeterminate:"",color:"primary"})):V.value?(u(),k("p",ce," Scroll for more... ")):i.value.length?(u(),k("p",_e," No more archetypes ")):T("",!0)],512),!A.value.length&&!_.value?(u(),k("div",me,[o(q,{size:"64",color:"grey"},{default:a(()=>[...e[10]||(e[10]=[r("mdi-package-variant",-1)])]),_:1}),e[11]||(e[11]=c("p",{class:"text-h6 mt-4"},"No archetypes found",-1))])):T("",!0),o(Q,{modelValue:b.value,"onUpdate:modelValue":e[5]||(e[5]=t=>b.value=t),"max-width":"500px"},{default:a(()=>[o(D,null,{default:a(()=>[o(w,null,{default:a(()=>{var t;return[r("Vote for "+v((t=x.value)==null?void 0:t.name),1)]}),_:1}),o(F,null,{default:a(()=>[o(G,{modelValue:p.value,"onUpdate:modelValue":e[2]||(e[2]=t=>p.value=t),min:.1,max:10,step:.1,label:"Credit Rate (ITC/day)","thumb-label":"",class:"mt-4"},null,8,["modelValue"]),c("div",pe,v(p.value)+" ITC/day ",1),o(H,{modelValue:I.value,"onUpdate:modelValue":e[3]||(e[3]=t=>I.value=t),label:"Reason for your vote (optional)",rows:"2",variant:"outlined"},null,8,["modelValue"])]),_:1}),o(K,null,{default:a(()=>[o(J),o(P,{text:"",onClick:e[4]||(e[4]=t=>b.value=!1)},{default:a(()=>[...e[12]||(e[12]=[r("Cancel",-1)])]),_:1}),o(P,{color:"primary",onClick:$},{default:a(()=>[...e[13]||(e[13]=[r("Submit Vote",-1)])]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1})]),_:1})}}};export{ke as default};
